import sys
import pickle
from collector import ErrorCollector, clean_text

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
try:
    with open('error_classifier.pkl', 'rb') as f:
        model = pickle.load(f)
except FileNotFoundError:
    model = None
    print("âš  ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¤Ð°Ð¹Ð» Ð¼Ð¾Ð´ÐµÐ»Ð¸ 'error_classifier.pkl' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½.")

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð»ÐµÐºÑ‚Ð¾Ñ€ (Ð±ÐµÐ· ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ñ„Ð°Ð¹Ð», Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð° ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°)
analyzer_collector = ErrorCollector(save_file='dummy.csv')

# --- Ð¡Ð›ÐžÐ’ÐÐ Ð¬ Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð™ (Ð Ð£Ð¡Ð˜Ð¤Ð˜ÐšÐÐ¦Ð˜Ð¯) ---
# Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ ÑÐ²ÑÐ·Ñ‹Ð²Ð°ÐµÐ¼ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ðµ ÐºÐ»Ð°ÑÑÑ‹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ñ Ñ€ÑƒÑÑÐºÐ¸Ð¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼
# Ð’ predictor.py Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ:

ADVICE_MAP = {
    'Database_Error': 
        "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ²ÑÐ·Ð°Ð½Ð° Ñ Ð‘Ð°Ð·Ð¾Ð¹ Ð”Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ…Ð¾ÑÑ‚, Ð¿Ð¾Ñ€Ñ‚, Ð»Ð¾Ð³Ð¸Ð½/Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ‚Ð¸.",
    
    'Validation_Error': 
        "ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚Ð¸Ð¿Ñ‹ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¸ Ð¸Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ.",
    
    'Logic_Calculation_Error': 
        "ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ¸. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð², Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð¾Ð»ÑŒ Ð¸ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ñ‹.",
        
    # --- ÐÐžÐ’Ð«Ð• Ð¢Ð˜ÐŸÐ« ---
    'FileSystem_Error':
        "ÐžÑˆÐ¸Ð±ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð°, Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (chmod) Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¿ÑƒÑ‚Ð¸.",
        
    'Security_Auth_Error':
        "ÐžÑˆÐ¸Ð±ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸, Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ€ÐµÑÑƒÑ€ÑÑƒ."
}

def smart_analyze(ex_type, ex_value, ex_traceback):
    """
    Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ except Ð±Ð»Ð¾ÐºÐ° Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸.
    """
    if not model:
        print("ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ trainer.py")
        return

    # 1. Ð—Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ + Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
    raw_text = analyzer_collector.capture_exception(ex_type, ex_value, ex_traceback, label=None)
    
    # 2. Ð§Ð¸ÑÑ‚Ð¸Ð¼ Ñ‚ÐµÐºÑÑ‚ (NLP)
    cleaned_input = clean_text(raw_text)
    
    # 3. ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ
    prediction = model.predict([cleaned_input])[0]
    proba = model.predict_proba([cleaned_input]).max()
    
    # 4. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð²ÐµÑ‚ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼
    # Ð•ÑÐ»Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð½ÐµÑ‚ Ð² ÑÐ»Ð¾Ð²Ð°Ñ€Ðµ, Ð²Ñ‹Ð´Ð°ÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    suggestion = ADVICE_MAP.get(prediction, "Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹ Ð½ÐµÑ‚. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚ÐµÐºÑ‚Ñ€ÐµÐ¹Ñ.")
    
    # 5. ÐšÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼
    print("\n" + "â•"*60)
    print("ðŸ¤– Ð˜ÐÐ¢Ð•Ð›Ð›Ð•ÐšÐ¢Ð£ÐÐ›Ð¬ÐÐ«Ð™ ÐÐÐÐ›Ð˜Ð— ÐžÐ¨Ð˜Ð‘ÐšÐ˜ (AI REPORT)")
    print("â•"*60)
    print(f"ðŸ”´ ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð» Ð¾ÑˆÐ¸Ð±ÐºÐ¸: {ex_type.__name__}: {ex_value}")
    print("â”€"*60)
    print(f"ðŸ§  ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ:      >> {prediction} <<")
    print(f"ðŸ“Š Ð£Ð²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ:    {proba:.1%}")
    print("â”€"*60)
    print(f"ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚:          {suggestion}")
    print("â•"*60 + "\n")

# --- Ð¢Ð•Ð¡Ð¢: Ð˜Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ (ÐµÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ) ---
if __name__ == "__main__":
    print("Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð°...")
    # ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð²Ñ‹Ð·Ð¾Ð²Ð°
    try:
        x = 1 / 0
    except Exception:
        smart_analyze(*sys.exc_info())